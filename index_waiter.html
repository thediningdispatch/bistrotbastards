<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="noindex, nofollow" />
  <title>Accueil serveur â€” Bistrot Bastards</title>
  <meta name="description" content="Retourne sur ta console serveur Bistrot Bastards." />
  <link rel="stylesheet" href="system7.css" />
  <link rel="stylesheet" href="assets/css/nav.css" />
  <style>
    html, body {
      overflow: hidden;
      height: 100%;
      position: fixed;
      width: 100%;
    }

    .waiter-home {
      display: flex;
      flex-direction: column;
      gap: 20px;
      padding: 32px 28px 40px;
      overflow-y: auto;
      max-height: calc(100vh - 112px);
    }

    #navHost {
      display: flex;
    }

    /* nav */
    .bb-nav { display:flex; align-items:center; gap:8px; }
    .bb-nav-inline { display:flex; gap:8px; }
    .bb-nav-menu { display:none; position:relative; margin-left:auto; }
    .bb-dropdown { position:absolute; top:100%; right:0; background:#fff; border:1px solid #000; box-shadow:2px 2px 0 #000; padding:6px; display:flex; flex-direction:column; min-width:160px; z-index:10; }
    .bb-dropdown a, .bb-dropdown button { text-align:left; padding:6px 8px; border:none; background:none; font:inherit; cursor:pointer; }
    @media (max-width:640px){
      .bb-nav-inline { display:none; }
      .bb-nav-menu { display:block; }
    }
    .bb-nav-left { margin-right:auto; }
    @media (min-width:641px){
      .bb-nav-inline { margin-left:auto; }
    }

    /* welcome */
    .bb-welcome { display:flex; flex-direction:column; gap:12px; }
    .bb-welcome-title { margin:4px 0 8px; }
    .bb-welcome-metrics { list-style:disc; margin:0 0 0 18px; padding:0; display:flex; flex-direction:column; gap:6px; }
    .bb-cta { margin-top:10px; display:flex; align-items:center; justify-content:space-between; gap:16px; flex-wrap:wrap; }
    .bb-btn-reviews { font-weight:700; font-size:18px; padding:10px 18px; background:#ffe89a; border:1px solid #000; box-shadow:2px 2px 0 #000; color:#000; }
    .bb-eth-link { display:inline-flex; align-items:center; justify-content:center; padding:8px 14px; border:1px solid #000; box-shadow:2px 2px 0 #000; background:#d1c8ff; }
    .bb-eth-icon { width:20px; height:30px; display:block; }
    .bb-eth-icon polygon:first-of-type { fill:#6d5bff; }
    .bb-eth-icon polygon:last-of-type { fill:#4432c8; }

    /* top3 */
    .bb-top3 { margin-top:16px; }
    .bb-top3-title { font-weight:700; margin-bottom:8px; display:inline-flex; align-items:center; padding:8px 12px; border:1px solid #000; box-shadow:2px 2px 0 #000; background:#fff; text-transform:uppercase; }
    .bb-top3-list { list-style:none; margin:0; padding:0; display:grid; gap:8px; }
    .bb-top3-list li { display:flex; align-items:center; gap:10px; padding:8px; border:1px solid #000; box-shadow:2px 2px 0 #000; background:#fff; }
    .bb-rank { display:inline-block; min-width:28px; text-align:center; font-weight:800; padding:2px 6px; border:1px solid #000; box-shadow:1px 1px 0 #000; background:#eee; }
    .bb-rank-1 { background:#ffe89a; }
    .bb-rank-2 { background:#e3ecff; }
    .bb-rank-3 { background:#e9ffe3; }
    .bb-user { font-weight:700; }
    .bb-score { margin-left:auto; font-variant-numeric:tabular-nums; }
  </style>
</head>
<body>
  <div class="desktop">
    <div class="window">
      <div class="title-bar">
        <div class="window-controls"><span></span><span></span><span></span></div>
        <span class="title-text">Console dâ€™accueil</span>
      </div>

      <div class="window-body waiter-home" id="app">
        <div id="navHost"></div>

        <div class="bb-welcome">
          <h2 class="bb-welcome-title">
            Content de te revoir, <span id="bbUserName">â€”</span> ðŸ‘‹
          </h2>
          <ul class="bb-welcome-metrics">
            <li>Jour <strong><span id="bbWeekDay">â€”</span>/7</strong> de ta semaine</li>
            <li>Tips cette semaine : <strong><span id="bbTipsWeek">â€”</span>â‚¬</strong></li>
            <li>Fin du concours dans <strong><span id="bbContestDays">â€”</span></strong> jours</li>
          </ul>
          <div class="bb-cta">
            <a href="#" class="btn bb-btn-reviews">REVIEWS</a>
            <a href="#" class="bb-eth-link" aria-label="Pourboires crypto" title="Pourboires crypto">
              <svg viewBox="0 0 32 48" class="bb-eth-icon" focusable="false">
                <polygon points="16,0 0,24 16,32 32,24"></polygon>
                <polygon points="16,48 0,28 16,36 32,28"></polygon>
              </svg>
            </a>
          </div>
        </div>

        <section class="bb-top3" aria-label="Top 3">
          <div class="bb-top3-title">Top 3</div>
          <ol id="bbTop3List" class="bb-top3-list">
            <!-- Filled dynamically -->
          </ol>
        </section>
      </div>
    </div>
  </div>

  <script>
    (function(){
      const u = JSON.parse(localStorage.getItem('bb_user') || '{}');
      const name = (u.username || '').toString().trim();
      if (name) document.getElementById('bbUserName').textContent = name.toUpperCase();

      const d = new Date();
      const jsDay = d.getDay(); // 0=Sun..6=Sat
      const weekDay = jsDay === 0 ? 7 : jsDay; // Monday=1..Sunday=7
      document.getElementById('bbWeekDay').textContent = weekDay;

      const tips = Number(localStorage.getItem('bb_tips_week') || NaN);
      document.getElementById('bbTipsWeek').textContent = Number.isFinite(tips) ? tips.toFixed(2) : 'â€”';

      // default contest ends Sunday of current week
      const tmp = new Date(d);
      const delta = (7 - (jsDay === 0 ? 7 : jsDay)) % 7;
      tmp.setDate(d.getDate() + delta);
      const msLeft = tmp.setHours(23,59,59,999) - Date.now();
      const daysLeft = Math.max(0, Math.ceil(msLeft / (1000*60*60*24)));
      document.getElementById('bbContestDays').textContent = daysLeft;
    })();
  </script>

  <script type="module">
    import { db } from './firebase.js';
    import { collection, getDocs, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const list = document.getElementById('bbTop3List');
    function renderFallback(){
      list.innerHTML = `
        <li><span class="bb-rank bb-rank-1">#1</span><span class="bb-user">PLAYER_1</span><span class="bb-score">â€”</span></li>
        <li><span class="bb-rank bb-rank-2">#2</span><span class="bb-user">PLAYER_2</span><span class="bb-score">â€”</span></li>
        <li><span class="bb-rank bb-rank-3">#3</span><span class="bb-user">PLAYER_3</span><span class="bb-score">â€”</span></li>
      `;
    }

    try {
      const q = query(collection(db, 'users'), orderBy('score', 'desc'), limit(3));
      const snap = await getDocs(q);
      if (snap.empty) { renderFallback(); }
      else {
        const rows = [];
        let rank = 1;
        snap.forEach(docu => {
          const d = docu.data() || {};
          rows.push(`
            <li>
              <span class="bb-rank bb-rank-${rank}">#${rank}</span>
              <span class="bb-user">${(d.username || 'PLAYER_'+rank).toString().toUpperCase()}</span>
              <span class="bb-score">${Number.isFinite(Number(d.score)) ? Number(d.score).toFixed(0) : 'â€”'}</span>
            </li>`);
          rank++;
        });
        list.innerHTML = rows.join('');
        // Fill missing ranks if fewer than 3
        for (; rank<=3; rank++){
          list.insertAdjacentHTML('beforeend', `
            <li>
              <span class="bb-rank bb-rank-${rank}">#${rank}</span>
              <span class="bb-user">PLAYER_${rank}</span>
              <span class="bb-score">â€”</span>
            </li>`);
        }
      }
    } catch (e) {
      console.error('[top3]', e);
      renderFallback();
    }
  </script>

  <script type="module" src="main.js"></script>
  <script type="module" src="auth-guard.js"></script>
</body>
</html>
