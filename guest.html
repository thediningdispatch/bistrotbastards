<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>TipFi — For Guest</title>
  <meta name="description" content="Pick your tip — we generate a payment QR for your wallet.">
  <style>
    :root{
      --bg:#0b0f19; --card:#121728; --line:rgba(255,255,255,.10);
      --text:#e8eeff; --muted:#9fb0c9; --chip:#0e1324;
      --accent1:#ffc000; --accent2:#ff7a00; /* brand-ish warm gradient */
      --ok:#2fd27b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(1000px 600px at 10% -10%, #1c2549 0%, transparent 60%),
        radial-gradient(800px 600px at 120% 10%, #1a2a5a 0%, transparent 55%),
        var(--bg);
      color:var(--text);
    }
    .wrap{max-width:820px; margin:28px auto; padding:0 16px}
    header{display:flex; align-items:center; justify-content:space-between; margin-bottom:14px}
    .title{font-weight:800; letter-spacing:.2px; font-size:18px}
    .tags{display:flex; gap:8px; flex-wrap:wrap}
    .tag{
      background:var(--chip);
      border:1px solid var(--line);
      color:var(--muted);
      font-size:12px; padding:6px 10px; border-radius:999px;
    }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.015));
      border:1px solid var(--line);
      border-radius:16px; padding:16px;
      box-shadow:0 10px 30px rgba(0,0,0,.25);
    }

    .hint{color:var(--muted); font-size:12px}

    /* Pretty percent grid */
    .percent-grid{
      display:grid; grid-template-columns:repeat(2, 1fr); gap:12px; margin-top:10px;
    }
    @media(min-width:760px){ .percent-grid{ grid-template-columns:repeat(4, 1fr); } }

    .pill{
      display:flex; flex-direction:column; justify-content:center; align-items:center;
      gap:4px; padding:14px 10px; border-radius:14px;
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid var(--line);
      cursor:pointer; user-select:none;
      transition:transform .12s ease, box-shadow .12s ease, border-color .12s ease;
      box-shadow:inset 0 0 0 1px rgba(255,255,255,.04), 0 6px 16px rgba(0,0,0,.25);
      text-align:center;
    }
    .pill:hover{ transform:translateY(-1px); }
    .pill:active{ transform:translateY(0); }
    .pill .pct{ font-size:22px; font-weight:900; letter-spacing:.2px }
    .pill .approx{ font-size:12px; color:var(--muted) }

    .pill.active{
      background:linear-gradient(135deg, var(--accent1), var(--accent2));
      border-color:transparent; color:#0a0a0a;
      box-shadow:0 6px 20px rgba(255,122,0,.35), 0 2px 10px rgba(255,192,0,.35);
    }
    .pill.active .approx{ color:#202020 }

    .custom{
      display:flex; gap:10px; align-items:center; margin-top:12px; flex-wrap:wrap;
    }
    input[type="number"]{
      width:140px; background:#0e1428; color:var(--text);
      border:1px solid var(--line); border-radius:12px;
      padding:12px 14px; font-size:16px; outline:none;
    }
    input[type="number"]:focus{ border-color:var(--accent1); box-shadow:0 0 0 3px rgba(255,192,0,.18) }

    .btn{
      cursor:pointer; background:linear-gradient(135deg, var(--accent1), var(--accent2));
      color:#1a1200; border:none; padding:12px 14px; border-radius:12px; font-weight:800;
      letter-spacing:.2px; box-shadow:0 6px 20px rgba(255,122,0,.35);
    }
    .btn.ghost{
      background:transparent; color:var(--text); border:1px solid var(--line);
      box-shadow:none;
    }
    .btn.small{ padding:10px 12px; font-size:14px }

    .summary{
      display:grid; grid-template-columns:1fr 1fr; gap:10px; margin:12px 0;
    }
    .kpi{
      background:#0c1130; border:1px solid var(--line); border-radius:12px;
      padding:12px 14px;
    }
    .kpi b{ display:block; font-size:12px; color:var(--muted) }
    .kpi span{ font-size:20px; font-weight:900 }

    .qrWrap{ margin-top:16px; display:none; }
    .qrBox{
      display:flex; align-items:center; justify-content:center;
      border-radius:16px; padding:18px; min-height:420px;
      background:#ffffff; /* ensures high contrast for scanners */
      border:1px solid #ffffff;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
    }
    .actions{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px }
    .uri{ color:var(--muted); font-size:12px; word-break:break-all; margin-top:6px }

    /* Nice little top divider */
    .divider{height:1px; background:var(--line); margin:12px 0}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">For Guest</div>
      <div class="tags">
        <span class="tag" id="tagCrypto">—</span>
        <span class="tag" id="tagFiat">—</span>
        <span class="tag" id="tagAddr">—</span>
      </div>
    </header>

    <section class="card">
      <div class="hint">Tap a percentage to tip</div>
      <div class="percent-grid" id="percentGroup" role="group" aria-label="Tip percentage">
        <button class="pill" data-p="5">
          <div class="pct">5%</div>
          <div class="approx">≈ —</div>
        </button>
        <button class="pill" data-p="10">
          <div class="pct">10%</div>
          <div class="approx">≈ —</div>
        </button>
        <button class="pill" data-p="15">
          <div class="pct">15%</div>
          <div class="approx">≈ —</div>
        </button>
        <button class="pill" data-p="20">
          <div class="pct">20%</div>
          <div class="approx">≈ —</div>
        </button>
      </div>

      <div class="custom">
        <span class="hint">Or set a custom %</span>
        <input id="customP" type="number" step="0.5" min="0" placeholder="e.g. 8" inputmode="decimal">
        <button class="btn small" id="applyCustom">Apply</button>
      </div>

      <div class="summary" aria-live="polite">
        <div class="kpi"><b>Bill</b><span id="billFiat">—</span></div>
        <div class="kpi"><b>Tip</b><span id="tipFiat">—</span></div>
      </div>

      <div class="divider"></div>

      <div class="qrWrap" id="qrWrap">
        <div class="qrBox" id="qrBox"><canvas id="qrCanvas"></canvas></div>
        <div class="actions">
          <button class="btn small" id="fullScreen">Fullscreen QR</button>
          <a class="btn small ghost" id="openWallet" target="_blank" rel="noopener">Open in wallet</a>
          <button class="btn small ghost" id="copyLink">Copy link</button>
          <button class="btn small ghost" id="copyAmount">Copy amount</button>
        </div>
        <div class="uri" id="uriPreview">—</div>
      </div>
    </section>
  </div>

  <!-- QR + decimals -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@latest/build/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/decimal.js@latest/decimal.min.js"></script>
  <script>
    const $ = s => document.querySelector(s)
    const qs = new URLSearchParams(location.search)
    const crypto = (qs.get('crypto') || 'ETH').toUpperCase()
    const fiat   = (qs.get('fiat') || 'EUR').toUpperCase()
    const addr   = (qs.get('addr') || '').trim()
    const bill   = parseFloat(qs.get('bill') || '0')

    // Top tags
    $('#tagCrypto').textContent = crypto
    $('#tagFiat').textContent   = fiat
    $('#tagAddr').textContent   = addr ? `…${addr.slice(-6)}` : '—'

    // Summary header
    $('#billFiat').textContent = bill > 0 ? `${bill.toFixed(2)} ${fiat}` : '—'

    // Show approx tip (in fiat) directly on the pill labels
    function refreshApprox(){
      document.querySelectorAll('.pill').forEach(btn => {
        const p = parseFloat(btn.dataset.p)
        const approx = bill > 0 ? new Decimal(bill).mul(p).div(100).toDecimalPlaces(2).toString() : '—'
        btn.querySelector('.approx').textContent = `≈ ${approx} ${fiat}`
      })
    }
    refreshApprox()

    // Live rate (with a tiny cache)
    const RATE_TTL_MS = 120000
    const rateKey = (c,f) => `TIPFI_RATE_${c}_${f}`

    async function getRate(crypto, fiat){
      // Cache first
      try{
        const cached = JSON.parse(localStorage.getItem(rateKey(crypto, fiat)) || 'null')
        if(cached && (Date.now() - cached.ts) < RATE_TTL_MS && cached.value > 0) return cached.value
      }catch(e){}

      const base = crypto === 'ETH' ? 'ETH' : 'BTC'
      const url = `https://api.coinbase.com/v2/exchange-rates?currency=${base}`
      const res = await fetch(url, { cache:'no-store' })
      if(!res.ok) throw new Error('Rate fetch failed')
      const json = await res.json()
      const perBaseInFiat = parseFloat(json?.data?.rates?.[fiat])
      if(!(perBaseInFiat > 0)) throw new Error('Invalid rate')
      try{ localStorage.setItem(rateKey(crypto, fiat), JSON.stringify({value:perBaseInFiat, ts:Date.now()})) }catch(e){}
      return perBaseInFiat
    }

    function formatBtc(dec){ return new Decimal(dec).toDecimalPlaces(8).toString() }
    function ethToWeiStr(eth){
      return new Decimal(eth).mul('1e18').toDecimalPlaces(0, Decimal.ROUND_FLOOR).toString()
    }

    function buildUri({ crypto, addr, fiatTip, rate }){
  if(crypto === 'BTC'){
    const btc = new Decimal(fiatTip).div(rate)
    const amt = btc.toDecimalPlaces(8).toString()
    return {
      uri: `bitcoin:${addr}?amount=${encodeURIComponent(amt)}`,
      amountLabel: `${amt} BTC`,
      deepLink: null
    }
  } else {
    // ETH
    const eth = new Decimal(fiatTip).div(rate)               // tip in ETH
    const wei = new Decimal(eth).mul('1e18').toDecimalPlaces(0).toString()
    const eip681 = `ethereum:${addr}?value=${wei}`           // generic QR (EIP-681)
    const mmDeep = `https://link.metamask.io/send/${addr}@1?value=${wei}` // MetaMask deeplink
    return {
      uri: eip681,
      amountLabel: `${eth.toSignificantDigits(8).toString()} ETH`,
      deepLink: mmDeep
    }
  }
}

async function renderForPercent(pct){
  if(!(bill > 0) || !addr){ alert('Missing bill or address.'); return }
  const tipFiat = new Decimal(bill).mul(pct).div(100)
  $('#tipFiat').textContent = `${tipFiat.toDecimalPlaces(2).toString()} ${fiat}`

  let rate
  try {
    rate = await getRate(crypto, fiat)
  } catch (e) {
    // Fallback: address-only QR
    const fallbackUri = crypto === 'BTC' ? `bitcoin:${addr}` : `ethereum:${addr}`
    await QRCode.toCanvas($('#qrCanvas'), fallbackUri, { width: 360, margin: 2 })
    $('#uriPreview').textContent = fallbackUri + '  (amount not prefilled)'
    $('#openWallet').href = fallbackUri
    $('#copyLink').onclick  = () => navigator.clipboard.writeText(fallbackUri)
    $('#copyAmount').onclick = () => navigator.clipboard.writeText(`${tipFiat.toString()} ${fiat}`)
    $('#qrWrap').style.display = 'block'
    return
  }

  const { uri, amountLabel, deepLink } = buildUri({ crypto, addr, fiatTip: tipFiat, rate })

  // QR stays generic (best for mixed wallets)
  await QRCode.toCanvas($('#qrCanvas'), uri, { width: 360, margin: 2 })
  $('#uriPreview').textContent = uri

  // Button opens MetaMask with amount prefilled (ETH only)
  $('#openWallet').href = deepLink || uri

  $('#copyLink').onclick  = () => navigator.clipboard.writeText(uri)
  $('#copyAmount').onclick = () => navigator.clipboard.writeText(amountLabel)
  $('#qrWrap').style.display = 'block'
}

    // Hook preset % buttons
    document.querySelectorAll('.pill').forEach(btn => {
      btn.addEventListener('click', () => renderForPercent(parseFloat(btn.dataset.p)))
    })

    // Custom %
    $('#applyCustom').addEventListener('click', () => {
      const pct = parseFloat($('#customP').value)
      if(!(pct >= 0)){ alert('Enter a valid percentage.'); return }
      // remove any preset highlight
      document.querySelectorAll('.pill').forEach(b => b.classList.remove('active'))
      const tipFiat = new Decimal(bill).mul(pct).div(100)
      $('#tipFiat').textContent = `${tipFiat.toDecimalPlaces(2)} ${fiat}`
      // proceed with rate + QR
      renderForPercent(pct)
    })

    // Fullscreen QR
    $('#fullScreen').addEventListener('click', () => {
      const box = $('#qrBox')
      if(box.requestFullscreen) box.requestFullscreen()
      else if(box.webkitRequestFullscreen) box.webkitRequestFullscreen()
    })
  </script>
</body>
</html>