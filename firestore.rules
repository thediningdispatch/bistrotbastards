rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function signedIn() { return request.auth != null; }
    function isAdmin() { return signedIn() && request.auth.token.isAdmin == true; }
    function userSelf(uid) { return signedIn() && request.auth.uid == uid; }
    function userProfileUpdateOnly() {
      // Autoriser l'utilisateur à modifier uniquement son profil public
      // (pas les scores/xp/etc.)
      let changed = request.resource.data.diff(resource.data).changedKeys();
      return changed.hasOnly(['username','avatar','avatarKey','photoURL'])
        && (request.resource.data.username is string || !('username' in changed))
        && (request.resource.data.avatar is string || !('avatar' in changed))
        && (request.resource.data.avatarKey is string || !('avatarKey' in changed))
        && (request.resource.data.photoURL is string || !('photoURL' in changed));
    }

    // USERS (classement + admin)
    match /users/{uid} {
      // Création par l'utilisateur lui-même
      allow create: if userSelf(uid);

      // LECTURE: tout utilisateur connecté (classement/performances) OU admin
      allow read: if signedIn() || isAdmin();

      // ÉCRITURE:
      // - Admin : total accès
      // - Utilisateur: seulement ses champs profil (username/avatar/…)
      allow update: if isAdmin() || (userSelf(uid) && userProfileUpdateOnly());

      // Suppression: admin uniquement
      allow delete: if isAdmin();
    }

    // CHAT: rooms/{roomId}/messages/{messageId}
    match /rooms/{roomId}/messages/{messageId} {
      // Lecture: tout utilisateur connecté
      allow read: if signedIn();

      allow create: if signedIn()
        && request.resource.data.uid == request.auth.uid
        && request.resource.data.username is string
        && request.resource.data.text is string
        && request.resource.data.text.size() > 0
        && request.resource.data.text.size() <= 400
        && request.resource.data.createdAt != null
        && request.resource.data.keys().hasOnly(['uid','username','text','createdAt']);

      allow update, delete: if false;
    }

    // Verrou par défaut
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
