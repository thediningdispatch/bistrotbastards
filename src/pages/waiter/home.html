<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="height=device-height, width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="robots" content="noindex, nofollow" />
  <title>Accueil serveur â€” Bistrot Bastards</title>
  <meta name="description" content="Retourne sur ta console serveur Bistrot Bastards." />
  <link rel="stylesheet" href="../../styles/system7.css" />
  <link rel="stylesheet" href="../../styles/navigation.css" />
  <link rel="stylesheet" href="../../styles/waiter-home.css" />
</head>
<body>
  <div class="app-container">
    <div class="desktop">
      <div class="window">
      <div class="title-bar">
        <div class="window-controls"><span></span><span></span><span></span></div>
        <span class="title-text">Bistrot Bastards</span>
      </div>

        <div class="window-body waiter-home" id="app">
          <div class="waiter-header">
            <div id="navHost"></div>
          </div>

          <div class="waiter-main">
            <div class="bb-welcome">
              <h2 class="bb-welcome-title">
                Content de te revoir, <span id="bbUserName">â€”</span> ðŸ‘‹
              </h2>
              <div class="bb-tips-boxes">
                <div class="bb-tip-box bb-tip-week">
                  <span class="bb-tip-label">Tips Semaine</span>
                  <span class="bb-tip-amount"><span id="bbTipsWeek">â€”</span>â‚¬</span>
                </div>
                <div class="bb-tip-box bb-tip-month">
                  <span class="bb-tip-label">Tips Mois</span>
                  <span class="bb-tip-amount"><span id="bbTipsMonth">â€”</span>â‚¬</span>
                </div>
                <div class="bb-tip-box bb-tip-avg">
                  <span class="bb-tip-label">Tips moyen / jour</span>
                  <span class="bb-tip-amount" aria-live="polite"><span id="bbAvgTips">â€”</span>â‚¬</span>
                </div>
                <div class="bb-tip-box bb-tip-contest">
                  <span class="bb-tip-label">Jours avant fin concours</span>
                  <span class="bb-tip-amount" aria-live="polite"><span id="bbContestDays">â€”</span></span>
                </div>
              </div>
              <div class="bb-cta">
                <a href="reviews.html" class="btn bb-btn-reviews">REVIEWS</a>
                <a href="crypto-tips.html" class="bb-eth-link" aria-label="Pourboires crypto" title="Pourboires crypto">
                  <svg viewBox="0 0 32 48" class="bb-eth-icon" focusable="false">
                    <polygon points="16,0 0,24 16,32 32,24"></polygon>
                    <polygon points="16,48 0,28 16,36 32,28"></polygon>
                  </svg>
                </a>
              </div>
            </div>

            <section class="bb-top3" aria-label="Top 3">
              <div class="bb-top3-title">Top 3</div>
              <div class="bb-top3-card">
                <ul id="bbTop3List" class="bb-top3-list">
                  <!-- Filled dynamically -->
                </ul>
              </div>
            </section>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function(){
      const user = JSON.parse(localStorage.getItem('bb_user') || '{}');
      const name = (user.username || '').toString().trim();
      if (name) {
        const nameEl = document.getElementById('bbUserName');
        if (nameEl) nameEl.textContent = name.toUpperCase();
      }

      const today = new Date();

      const CONTEST_END = new Date('2025-12-31T23:59:59');
      const contestEl = document.getElementById('bbContestDays');
      if (contestEl) {
        const diffMs = CONTEST_END.getTime() - today.getTime();
        const daysLeft = Math.max(0, Math.ceil(diffMs / (1000 * 60 * 60 * 24)));
        contestEl.textContent = daysLeft > 0 ? daysLeft : 'TerminÃ©';
      }

      function safeParse(key, fallback) {
        try {
          const raw = localStorage.getItem(key);
          if (!raw) return fallback;
          const parsed = JSON.parse(raw);
          return parsed ?? fallback;
        } catch (_err) {
          return fallback;
        }
      }

      const tipsWeekObj = safeParse('bb_tips_week', {});
      const sumTips = Object.values(tipsWeekObj || {}).reduce((acc, val) => {
        const num = Number(val);
        return Number.isFinite(num) && num >= 0 ? acc + num : acc;
      }, 0);
      const tipsWeekEl = document.getElementById('bbTipsWeek');
      if (tipsWeekEl) {
        tipsWeekEl.textContent = sumTips.toFixed(2);
      }

      const tipsHistoryRaw = safeParse('bb_tips_history', {});
      const tipsHistory = tipsHistoryRaw && typeof tipsHistoryRaw === 'object' ? tipsHistoryRaw : {};
      const currentMonthKey = today.toISOString().slice(0, 7);
      const monthTips = Object.entries(tipsHistory).reduce((acc, entry) => {
        const [date, value] = entry;
        if (typeof date === 'string' && date.startsWith(currentMonthKey)) {
          const num = Number(value);
          return Number.isFinite(num) ? acc + num : acc;
        }
        return acc;
      }, 0);
      const tipsMonthEl = document.getElementById('bbTipsMonth');
      if (tipsMonthEl) {
        tipsMonthEl.textContent = monthTips.toFixed(2);
      }

      // Calculate average tips per day
      function calculateAverageTipsPerDay(history) {
        if (!history || typeof history !== 'object') {
          return 0;
        }
        const entries = Object.entries(history);
        if (entries.length === 0) {
          return 0;
        }
        let totalTips = 0;
        let validDays = 0;
        for (const [date, amount] of entries) {
          const num = Number(amount);
          if (Number.isFinite(num) && num >= 0) {
            totalTips += num;
            validDays++;
          }
        }
        if (validDays === 0) {
          return 0;
        }
        return totalTips / validDays;
      }

      const avgTips = calculateAverageTipsPerDay(tipsHistory);
      const avgTipsEl = document.getElementById('bbAvgTips');
      if (avgTipsEl) {
        avgTipsEl.textContent = avgTips > 0 ? avgTips.toFixed(2) : 'â€”';
      }
    })();
  </script>

  <script type="module">
    import { db } from '../../scripts/core/firebase.js';
    import { collection, getDocs, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const list = document.getElementById('bbTop3List');
    function renderFallback(){
      list.innerHTML = `
        <li><span class="bb-rank bb-rank-1">#1</span><span class="bb-user">PLAYER_1</span><span class="bb-score">â€”</span></li>
        <li><span class="bb-rank bb-rank-2">#2</span><span class="bb-user">PLAYER_2</span><span class="bb-score">â€”</span></li>
        <li><span class="bb-rank bb-rank-3">#3</span><span class="bb-user">PLAYER_3</span><span class="bb-score">â€”</span></li>
      `;
    }

    try {
      const q = query(collection(db, 'users'), orderBy('score', 'desc'), limit(3));
      const snap = await getDocs(q);
      if (snap.empty) { renderFallback(); }
      else {
        const rows = [];
        let rank = 1;
        snap.forEach(docu => {
          const d = docu.data() || {};
          rows.push(`
            <li>
              <span class="bb-rank bb-rank-${rank}">#${rank}</span>
              <span class="bb-user">${(d.username || 'PLAYER_'+rank).toString().toUpperCase()}</span>
              <span class="bb-score">${Number.isFinite(Number(d.score)) ? Number(d.score).toFixed(0) : 'â€”'}</span>
            </li>`);
          rank++;
        });
        list.innerHTML = rows.join('');
        // Fill missing ranks if fewer than 3
        for (; rank<=3; rank++){
          list.insertAdjacentHTML('beforeend', `
            <li>
              <span class="bb-rank bb-rank-${rank}">#${rank}</span>
              <span class="bb-user">PLAYER_${rank}</span>
              <span class="bb-score">â€”</span>
            </li>`);
        }
      }
    } catch (e) {
      console.error('[top3]', e);
      renderFallback();
    }
  </script>

  <script type="module" src="../../scripts/core/navigation.js"></script>
  <script type="module" src="../../scripts/core/auth-guard.js"></script>
</body>
</html>
