<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="noindex, nofollow" />
  <title>Paiements blockchain — Console serveur</title>
  <meta name="description" content="Configure tes préférences de portefeuille avant de générer un lien de pourboire." />
  <link rel="stylesheet" href="system7.css" />
</head>
<body>
  <div class="desktop">
    <div class="menu-bar">
      <span class="menu-item menu-apple"></span>
      <span class="menu-item">Pourboires crypto (réglages équipe)</span>
    </div>

    <div class="window">
      <div class="title-bar">
        <div class="window-controls"><span></span><span></span><span></span></div>
        <span class="title-text">Console de configuration serveur</span>
      </div>

      <div class="window-body" id="app">
        <div class="toolbar" id="waiterLogoBar">
          <a class="btn" href="index.html">← Accueil</a>
          <h1 class="logo-text">Bistrot Bastards</h1>
        </div>

        <h2>Console serveur</h2>
        <p>Configure tes paramètres avant de montrer la page de pourboire au client. Tout est enregistré localement sur cet appareil.</p>

        <div class="tag-list">
          <span class="tag" id="tagCrypto">—</span>
          <span class="tag" id="tagFiat">—</span>
          <span class="tag" id="tagAddr">—</span>
        </div>

        <span class="beta-badge">Version bêta — attendez-vous à quelques aspérités</span>

        <form>
          <div class="two-column">
            <div>
              <label for="crypto">Réseau crypto</label>
              <select id="crypto">
                <option value="ETH">Ethereum (ETH)</option>
                <option value="BTC">Bitcoin (BTC)</option>
              </select>
            </div>
            <div>
              <label for="fiat">Devise de l’addition</label>
              <select id="fiat">
                <option value="USD">US Dollar ($)</option>
                <option value="EUR">Euro (€)</option>
              </select>
            </div>
          </div>

          <div class="two-column">
            <div>
              <label for="bill">Montant de l’addition</label>
              <input id="bill" type="number" step="0.01" min="0" placeholder="Saisis le montant de l’addition" />
            </div>
            <div>
              <label for="address">Adresse de portefeuille</label>
              <input id="address" placeholder="Saisis ton adresse de portefeuille" />
            </div>
          </div>

          <div class="actions">
            <button type="button" class="btn" id="toGuest">Prévisualiser côté client</button>
            <button type="button" class="btn" id="saveDefaults">Enregistrer</button>
            <button type="button" class="btn" id="clearDefaults">Réinitialiser</button>
          </div>
        </form>

        <div class="window" id="guestWindow">
          <div class="title-bar">
            <div class="window-controls"><span></span><span></span><span></span></div>
            <span class="title-text">Console client pourboire</span>
          </div>

          <div class="window-body">
            <h2>Console client pourboire</h2>
            <p>Choisis ton pourboire, scanne le QR code et confirme le montant dans ton portefeuille.</p>

            <div class="tag-list">
              <span class="tag" id="guestTagCrypto">—</span>
              <span class="tag" id="guestTagFiat">—</span>
              <span class="tag" id="guestTagAddr">—</span>
            </div>

            <span class="beta-badge">Version bêta — vérifie les détails avant d’envoyer les fonds</span>

            <div class="hint">Sélectionne un pourcentage prédéfini</div>
            <div class="percent-grid" id="guestPercentGrid">
              <button class="pill" data-p="5"><div class="pct">5%</div><div class="approx">≈ —</div></button>
              <button class="pill" data-p="10"><div class="pct">10%</div><div class="approx">≈ —</div></button>
              <button class="pill" data-p="15"><div class="pct">15%</div><div class="approx">≈ —</div></button>
              <button class="pill" data-p="20"><div class="pct">20%</div><div class="approx">≈ —</div></button>
            </div>

            <div class="toolbar">
              <span class="hint">Ou saisis ton propre %</span>
              <input id="guestCustomP" type="number" step="0.5" min="0" placeholder="% personnalisé" />
              <button class="btn" id="guestApplyCustom" type="button">Appliquer</button>
            </div>

            <div class="summary">
              <div class="kpi"><b>Addition</b><span id="guestBillFiat">—</span></div>
              <div class="kpi"><b>Pourboire</b><span id="guestTipFiat">—</span></div>
            </div>

            <div class="qr-wrap" id="guestQrWrap">
              <div class="qr-box"><canvas id="guestQrCanvas"></canvas></div>
              <p class="qr-hint">Taux en direct depuis Coinbase. Vérifie toujours le montant final avant de confirmer.</p>
              <div class="actions">
                <a class="btn" id="guestOpenWallet" target="_blank" rel="noopener noreferrer">Ouvrir le portefeuille</a>
                <button class="btn" id="guestCopyLink" type="button">Copier le lien de paiement</button>
                <button class="btn" id="guestCopyAmount" type="button">Copier le montant du pourboire</button>
              </div>
              <div class="uri-preview" id="guestUriPreview">—</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module" src="main.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@latest/build/qrcode.min.js"></script>
  <script>
    const $ = selector => document.querySelector(selector);
    const $$ = selector => Array.from(document.querySelectorAll(selector));
    const LS = { crypto: 'TIPFI_CRYPTO', addr: 'TIPFI_ADDR', fiat: 'TIPFI_FIAT' };

    const staffInputs = {
      crypto: $('#crypto'),
      fiat: $('#fiat'),
      address: $('#address'),
      bill: $('#bill')
    };

    const staffTags = {
      crypto: $('#tagCrypto'),
      fiat: $('#tagFiat'),
      addr: $('#tagAddr')
    };

    const guestState = {
      crypto: 'ETH',
      fiat: 'USD',
      addr: '',
      bill: 0,
      lastPercent: null
    };

    const guestEls = {
      tags: {
        crypto: $('#guestTagCrypto'),
        fiat: $('#guestTagFiat'),
        addr: $('#guestTagAddr')
      },
      percentButtons: $$('#guestPercentGrid .pill'),
      customInput: $('#guestCustomP'),
      applyCustom: $('#guestApplyCustom'),
      summaryBill: $('#guestBillFiat'),
      summaryTip: $('#guestTipFiat'),
      qrWrap: $('#guestQrWrap'),
      qrCanvas: $('#guestQrCanvas'),
      openWallet: $('#guestOpenWallet'),
      copyLink: $('#guestCopyLink'),
      copyAmount: $('#guestCopyAmount'),
      uriPreview: $('#guestUriPreview')
    };

    function refreshStaffTags() {
      const crypto = staffInputs.crypto.value;
      const fiat = staffInputs.fiat.value;
      const addr = (staffInputs.address.value || '').trim();
      staffTags.crypto.textContent = crypto;
      staffTags.fiat.textContent = fiat;
      staffTags.addr.textContent = addr ? `…${addr.slice(-6)}` : '—';
    }

    function updateGuestTags() {
      const hasContext = guestState.bill > 0 && !!guestState.addr;
      guestEls.tags.crypto.textContent = hasContext ? guestState.crypto : '—';
      guestEls.tags.fiat.textContent = hasContext ? guestState.fiat : '—';
      guestEls.tags.addr.textContent = hasContext ? `…${guestState.addr.slice(-6)}` : '—';
      guestEls.summaryBill.textContent = hasContext
        ? `${guestState.bill.toFixed(2)} ${guestState.fiat}`
        : '—';
    }

    function resetGuestView() {
      guestState.lastPercent = null;
      guestEls.percentButtons.forEach(btn => btn.classList.remove('active'));
      guestEls.qrWrap.style.display = 'none';
      guestEls.summaryTip.textContent = '—';
      guestEls.uriPreview.textContent = '—';
    }

    function refreshGuestApprox() {
      guestEls.percentButtons.forEach(btn => {
        const percent = parseFloat(btn.dataset.p);
        const approx = guestState.bill > 0 ? (guestState.bill * percent / 100).toFixed(2) : '—';
        btn.querySelector('.approx').textContent = guestState.bill > 0
          ? `≈ ${approx} ${guestState.fiat}`
          : '≈ —';
      });
    }

    function setGuestContext({ crypto, fiat, addr, bill }) {
      guestState.crypto = crypto;
      guestState.fiat = fiat;
      guestState.addr = addr;
      guestState.bill = bill;
      updateGuestTags();
      resetGuestView();
      refreshGuestApprox();
      document.getElementById('guestWindow').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    async function renderGuestForPercent(percent) {
      if (!(guestState.bill > 0) || !guestState.addr) {
        alert('Configure d’abord la console serveur.');
        return;
      }

      guestState.lastPercent = percent;
      const tipFiat = guestState.bill * percent / 100;
      guestEls.summaryTip.textContent = `${tipFiat.toFixed(2)} ${guestState.fiat}`;

      try {
        const rateRes = await fetch(`https://api.coinbase.com/v2/exchange-rates?currency=${guestState.crypto}`);
        const rateJson = await rateRes.json();
        const rate = parseFloat(rateJson.data.rates[guestState.fiat]);
        if (!(rate > 0)) throw new Error('Invalid rate');

        const tipCrypto = tipFiat / rate;
        const uri = `${guestState.crypto.toLowerCase()}:${guestState.addr}?amount=${tipCrypto}`;

        guestEls.uriPreview.textContent = uri;
        QRCode.toCanvas(guestEls.qrCanvas, uri, { width: 220 });

        guestEls.openWallet.href = uri;
        guestEls.copyLink.onclick = () => navigator.clipboard.writeText(uri);
        guestEls.copyAmount.onclick = () => navigator.clipboard.writeText(`${tipFiat.toFixed(2)} ${guestState.fiat}`);
        guestEls.qrWrap.style.display = 'block';
      } catch (error) {
        console.error(error);
        alert('Impossible de récupérer le taux en direct — réessaie.');
      }
    }

    guestEls.percentButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        guestEls.percentButtons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        renderGuestForPercent(parseFloat(btn.dataset.p));
      });
    });

    guestEls.applyCustom.addEventListener('click', () => {
      const percent = parseFloat(guestEls.customInput.value);
      if (!(percent >= 0)) {
        alert('Entre un pourcentage valide.');
        return;
      }
      guestEls.percentButtons.forEach(b => b.classList.remove('active'));
      renderGuestForPercent(percent);
    });

    window.addEventListener('DOMContentLoaded', () => {
      staffInputs.crypto.value = localStorage.getItem(LS.crypto) || 'ETH';
      staffInputs.address.value = localStorage.getItem(LS.addr) || '';
      staffInputs.fiat.value = localStorage.getItem(LS.fiat) || 'USD';
      staffInputs.bill.value = '';
      refreshStaffTags();
      updateGuestTags();
      resetGuestView();
      refreshGuestApprox();
    });

    ['crypto', 'address', 'fiat'].forEach(id => {
      $(`#${id}`).addEventListener('input', refreshStaffTags);
      $(`#${id}`).addEventListener('change', refreshStaffTags);
    });

    document.getElementById('saveDefaults').addEventListener('click', () => {
      localStorage.setItem(LS.crypto, staffInputs.crypto.value);
      localStorage.setItem(LS.fiat, staffInputs.fiat.value);
      localStorage.setItem(LS.addr, (staffInputs.address.value || '').trim());
      alert('Préférences enregistrées.');
    });

    document.getElementById('clearDefaults').addEventListener('click', () => {
      Object.values(LS).forEach(key => localStorage.removeItem(key));
      staffInputs.crypto.value = 'ETH';
      staffInputs.fiat.value = 'USD';
      staffInputs.address.value = '';
      staffInputs.bill.value = '';
      guestState.crypto = 'ETH';
      guestState.fiat = 'USD';
      guestState.addr = '';
      guestState.bill = 0;
      refreshStaffTags();
      updateGuestTags();
      resetGuestView();
      refreshGuestApprox();
      alert('Réinitialisé.');
    });

    document.getElementById('toGuest').addEventListener('click', () => {
      const crypto = staffInputs.crypto.value;
      const addr = (staffInputs.address.value || '').trim();
      const billValue = parseFloat(staffInputs.bill.value);
      const fiat = staffInputs.fiat.value;

      if (!addr) {
        alert('Saisis ton adresse de portefeuille.');
        return;
      }
      if (!(billValue > 0)) {
        alert('Entre un montant d’addition supérieur à 0.');
        return;
      }

      localStorage.setItem(LS.crypto, crypto);
      localStorage.setItem(LS.fiat, fiat);
      localStorage.setItem(LS.addr, addr);

      setGuestContext({ crypto, fiat, addr, bill: billValue });
    });
  </script>
  <script type="module" src="auth-guard.js"></script>
</body>
</html>
