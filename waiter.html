<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="noindex, nofollow" />
  <title>Blockchain Payments — Waiter Console</title>
  <meta name="description" content="Configure your wallet defaults before generating a guest tipping link." />
  <link rel="stylesheet" href="system7.css" />
</head>
<body>
  <nav class="top-nav window">
    <div class="nav-inner">
      <div class="nav-left">
        <div class="nav-avatar" id="navAvatar">B</div>
        <div class="nav-username">
          <span id="navUsername">Loading…</span>
          <small id="navRole">waiter</small>
        </div>
      </div>
      <div class="nav-links">
        <a href="dashboard.html" data-nav="dashboard">Dashboard</a>
        <a href="leaderboard.html" data-nav="leaderboard">Leaderboard</a>
        <a href="chat.html" data-nav="chat">Chat</a>
        <a href="dashboard.html#profile" data-nav="profile">Profile</a>
        <a href="logout" data-nav="logout">Logout</a>
      </div>
    </div>
  </nav>

  <div class="desktop">
    <div class="menu-bar">
      <span class="menu-item menu-apple"></span>
      <span class="menu-item">Crypto Tipping (staff setup)</span>
    </div>

    <div class="window">
      <div class="title-bar">
        <div class="window-controls"><span></span><span></span><span></span></div>
        <span class="title-text">Waiter Setup Console</span>
      </div>

      <div class="window-body">
        <div id="app">
          <div class="toolbar">
            <a class="btn" href="index.html">← Home</a>
            <img src="logo_website.png" alt="Bistrot Bastards logo" class="hero-logo" onerror="this.onerror=null;this.src='logo_1.svg';" />
          </div>

          <h1>Waiter Setup Console</h1>
          <p>Configure your defaults before handing guests the tipping page. Everything saves locally on this device.</p>

          <div class="tag-list">
            <span class="tag" id="tagCrypto">—</span>
            <span class="tag" id="tagFiat">—</span>
            <span class="tag" id="tagAddr">—</span>
          </div>

          <span class="beta-badge">Beta build — expect rough edges</span>

          <form>
            <div class="two-column">
              <div>
                <label for="crypto">Crypto network</label>
                <select id="crypto">
                  <option value="ETH">Ethereum (ETH)</option>
                  <option value="BTC">Bitcoin (BTC)</option>
                </select>
              </div>
              <div>
                <label for="fiat">Bill currency</label>
                <select id="fiat">
                  <option value="USD">US Dollar ($)</option>
                  <option value="EUR">Euro (€)</option>
                </select>
              </div>
            </div>

            <div class="two-column">
              <div>
                <label for="bill">Bill amount</label>
                <input id="bill" type="number" step="0.01" min="0" placeholder="Enter bill amount" />
              </div>
              <div>
                <label for="address">Wallet address</label>
                <input id="address" placeholder="Enter your wallet address" />
              </div>
            </div>

            <div class="actions">
              <button type="button" class="btn" id="toGuest">Preview Guest Flow</button>
              <button type="button" class="btn" id="saveDefaults">Save defaults</button>
              <button type="button" class="btn" id="clearDefaults">Clear</button>
            </div>
          </form>

          <div class="window" id="guestWindow">
            <div class="title-bar">
              <div class="window-controls"><span></span><span></span><span></span></div>
              <span class="title-text">Guest Tipping Console</span>
            </div>

            <div class="window-body">
              <h1>Guest Tipping Console</h1>
              <p>Select your tip, scan the QR code, and confirm the amount inside your wallet.</p>

              <div class="tag-list">
                <span class="tag" id="guestTagCrypto">—</span>
                <span class="tag" id="guestTagFiat">—</span>
                <span class="tag" id="guestTagAddr">—</span>
              </div>

              <span class="beta-badge">Beta build — verify all details before sending funds</span>

              <div class="hint">Select a preset percentage</div>
              <div class="percent-grid" id="guestPercentGrid">
                <button class="pill" data-p="5"><div class="pct">5%</div><div class="approx">≈ —</div></button>
                <button class="pill" data-p="10"><div class="pct">10%</div><div class="approx">≈ —</div></button>
                <button class="pill" data-p="15"><div class="pct">15%</div><div class="approx">≈ —</div></button>
                <button class="pill" data-p="20"><div class="pct">20%</div><div class="approx">≈ —</div></button>
              </div>

              <div class="toolbar">
                <span class="hint">Or enter a custom %</span>
                <input id="guestCustomP" type="number" step="0.5" min="0" placeholder="Custom %" />
                <button class="btn" id="guestApplyCustom" type="button">Apply</button>
              </div>

              <div class="summary">
                <div class="kpi"><b>Bill</b><span id="guestBillFiat">—</span></div>
                <div class="kpi"><b>Tip</b><span id="guestTipFiat">—</span></div>
              </div>

              <div class="qr-wrap" id="guestQrWrap">
                <div class="qr-box"><canvas id="guestQrCanvas"></canvas></div>
                <p class="qr-hint">Live rates from Coinbase. Always double-check the final amount before confirming.</p>
                <div class="actions">
                  <a class="btn" id="guestOpenWallet" target="_blank" rel="noopener noreferrer">Open Wallet</a>
                  <button class="btn" id="guestCopyLink" type="button">Copy Payment Link</button>
                  <button class="btn" id="guestCopyAmount" type="button">Copy Tip Amount</button>
                </div>
                <div class="uri-preview" id="guestUriPreview">—</div>
              </div>

              <footer class="footer">
                <p>
                  <a href="https://www.reddit.com/u/Square_Ad_7551" target="_blank" rel="noopener noreferrer">@Square_Ad_7551</a>
                  — Open-source under the
                  <a href="https://www.gnu.org/licenses/agpl-3.0.html" target="_blank" rel="noopener noreferrer">AGPL-3.0 License</a>.
                  Feel free to reuse or remix this code as long as your project stays open-source too.
                </p>
              </footer>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="main.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@latest/build/qrcode.min.js"></script>
  <script>
    const $ = selector => document.querySelector(selector);
    const $$ = selector => Array.from(document.querySelectorAll(selector));
    const LS = { crypto: 'TIPFI_CRYPTO', addr: 'TIPFI_ADDR', fiat: 'TIPFI_FIAT' };

    const staffInputs = {
      crypto: $('#crypto'),
      fiat: $('#fiat'),
      address: $('#address'),
      bill: $('#bill')
    };

    const staffTags = {
      crypto: $('#tagCrypto'),
      fiat: $('#tagFiat'),
      addr: $('#tagAddr')
    };

    const guestState = {
      crypto: 'ETH',
      fiat: 'USD',
      addr: '',
      bill: 0,
      lastPercent: null
    };

    const guestEls = {
      tags: {
        crypto: $('#guestTagCrypto'),
        fiat: $('#guestTagFiat'),
        addr: $('#guestTagAddr')
      },
      percentButtons: $$('#guestPercentGrid .pill'),
      customInput: $('#guestCustomP'),
      applyCustom: $('#guestApplyCustom'),
      summaryBill: $('#guestBillFiat'),
      summaryTip: $('#guestTipFiat'),
      qrWrap: $('#guestQrWrap'),
      qrCanvas: $('#guestQrCanvas'),
      openWallet: $('#guestOpenWallet'),
      copyLink: $('#guestCopyLink'),
      copyAmount: $('#guestCopyAmount'),
      uriPreview: $('#guestUriPreview')
    };

    function refreshStaffTags() {
      const crypto = staffInputs.crypto.value;
      const fiat = staffInputs.fiat.value;
      const addr = (staffInputs.address.value || '').trim();
      staffTags.crypto.textContent = crypto;
      staffTags.fiat.textContent = fiat;
      staffTags.addr.textContent = addr ? `…${addr.slice(-6)}` : '—';
    }

    function updateGuestTags() {
      const hasContext = guestState.bill > 0 && !!guestState.addr;
      guestEls.tags.crypto.textContent = hasContext ? guestState.crypto : '—';
      guestEls.tags.fiat.textContent = hasContext ? guestState.fiat : '—';
      guestEls.tags.addr.textContent = hasContext ? `…${guestState.addr.slice(-6)}` : '—';
      guestEls.summaryBill.textContent = hasContext
        ? `${guestState.bill.toFixed(2)} ${guestState.fiat}`
        : '—';
    }

    function resetGuestView() {
      guestState.lastPercent = null;
      guestEls.percentButtons.forEach(btn => btn.classList.remove('active'));
      guestEls.qrWrap.style.display = 'none';
      guestEls.summaryTip.textContent = '—';
      guestEls.uriPreview.textContent = '—';
    }

    function refreshGuestApprox() {
      guestEls.percentButtons.forEach(btn => {
        const percent = parseFloat(btn.dataset.p);
        const approx = guestState.bill > 0 ? (guestState.bill * percent / 100).toFixed(2) : '—';
        btn.querySelector('.approx').textContent = guestState.bill > 0
          ? `≈ ${approx} ${guestState.fiat}`
          : '≈ —';
      });
    }

    function setGuestContext({ crypto, fiat, addr, bill }) {
      guestState.crypto = crypto;
      guestState.fiat = fiat;
      guestState.addr = addr;
      guestState.bill = bill;
      updateGuestTags();
      resetGuestView();
      refreshGuestApprox();
      document.getElementById('guestWindow').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    async function renderGuestForPercent(percent) {
      if (!(guestState.bill > 0) || !guestState.addr) {
        alert('Configure the waiter console first.');
        return;
      }

      guestState.lastPercent = percent;
      const tipFiat = guestState.bill * percent / 100;
      guestEls.summaryTip.textContent = `${tipFiat.toFixed(2)} ${guestState.fiat}`;

      try {
        const rateRes = await fetch(`https://api.coinbase.com/v2/exchange-rates?currency=${guestState.crypto}`);
        const rateJson = await rateRes.json();
        const rate = parseFloat(rateJson.data.rates[guestState.fiat]);
        if (!(rate > 0)) throw new Error('Invalid rate');

        const tipCrypto = tipFiat / rate;
        const uri = `${guestState.crypto.toLowerCase()}:${guestState.addr}?amount=${tipCrypto}`;

        guestEls.uriPreview.textContent = uri;
        QRCode.toCanvas(guestEls.qrCanvas, uri, { width: 220 });

        guestEls.openWallet.href = uri;
        guestEls.copyLink.onclick = () => navigator.clipboard.writeText(uri);
        guestEls.copyAmount.onclick = () => navigator.clipboard.writeText(`${tipFiat.toFixed(2)} ${guestState.fiat}`);
        guestEls.qrWrap.style.display = 'block';
      } catch (error) {
        console.error(error);
        alert('Could not fetch the live rate — please retry.');
      }
    }

    guestEls.percentButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        guestEls.percentButtons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        renderGuestForPercent(parseFloat(btn.dataset.p));
      });
    });

    guestEls.applyCustom.addEventListener('click', () => {
      const percent = parseFloat(guestEls.customInput.value);
      if (!(percent >= 0)) {
        alert('Enter a valid percentage.');
        return;
      }
      guestEls.percentButtons.forEach(b => b.classList.remove('active'));
      renderGuestForPercent(percent);
    });

    window.addEventListener('DOMContentLoaded', () => {
      staffInputs.crypto.value = localStorage.getItem(LS.crypto) || 'ETH';
      staffInputs.address.value = localStorage.getItem(LS.addr) || '';
      staffInputs.fiat.value = localStorage.getItem(LS.fiat) || 'USD';
      staffInputs.bill.value = '';
      refreshStaffTags();
      updateGuestTags();
      resetGuestView();
      refreshGuestApprox();
    });

    ['crypto', 'address', 'fiat'].forEach(id => {
      $(`#${id}`).addEventListener('input', refreshStaffTags);
      $(`#${id}`).addEventListener('change', refreshStaffTags);
    });

    document.getElementById('saveDefaults').addEventListener('click', () => {
      localStorage.setItem(LS.crypto, staffInputs.crypto.value);
      localStorage.setItem(LS.fiat, staffInputs.fiat.value);
      localStorage.setItem(LS.addr, (staffInputs.address.value || '').trim());
      alert('Defaults saved.');
    });

    document.getElementById('clearDefaults').addEventListener('click', () => {
      Object.values(LS).forEach(key => localStorage.removeItem(key));
      staffInputs.crypto.value = 'ETH';
      staffInputs.fiat.value = 'USD';
      staffInputs.address.value = '';
      staffInputs.bill.value = '';
      guestState.crypto = 'ETH';
      guestState.fiat = 'USD';
      guestState.addr = '';
      guestState.bill = 0;
      refreshStaffTags();
      updateGuestTags();
      resetGuestView();
      refreshGuestApprox();
      alert('Cleared.');
    });

    document.getElementById('toGuest').addEventListener('click', () => {
      const crypto = staffInputs.crypto.value;
      const addr = (staffInputs.address.value || '').trim();
      const billValue = parseFloat(staffInputs.bill.value);
      const fiat = staffInputs.fiat.value;

      if (!addr) {
        alert('Please enter your wallet address.');
        return;
      }
      if (!(billValue > 0)) {
        alert('Enter a bill amount greater than 0.');
        return;
      }

      localStorage.setItem(LS.crypto, crypto);
      localStorage.setItem(LS.fiat, fiat);
      localStorage.setItem(LS.addr, addr);

      setGuestContext({ crypto, fiat, addr, bill: billValue });
    });
  </script>
</body>
</html>
